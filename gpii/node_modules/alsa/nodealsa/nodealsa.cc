/*
 * GPII Node.js Alsa bridge
 *
 * Copyright 2012 Emergya
 * Copyright 2015 Raising the Floor
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The research leading to these results has received funding from the European Union's
 * Seventh Framework Programme (FP7/2007-2013)
 * under grant agreement no. 289016.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

#include <nan.h>
#include <stdio.h>
#include <math.h>
#include <alsa/asoundlib.h>

using namespace v8;
using v8::FunctionTemplate;
using v8::Object;
using v8::String;
using Nan::GetFunction;
using Nan::New;
using Nan::Set;
using Nan::ThrowError;


NAN_METHOD(getSystemVolume) {
    snd_mixer_t *handle;
    snd_mixer_selem_id_t *sid;
    const char *card = "default";
    const char *selem_name = "Master";

    snd_mixer_open(&handle, 0);
    snd_mixer_attach(handle, card);
    snd_mixer_selem_register(handle, NULL, NULL);
    snd_mixer_load(handle);

    snd_mixer_selem_id_alloca(&sid);
    snd_mixer_selem_id_set_index(sid, 0);
    snd_mixer_selem_id_set_name(sid, selem_name);
    snd_mixer_elem_t* elem = snd_mixer_find_selem(handle, sid);

    snd_mixer_selem_set_playback_volume_range(elem, 0, 100);

    long curr;

    snd_mixer_selem_get_playback_volume(elem,(snd_mixer_selem_channel_id_t) 0, &curr);

    snd_mixer_close(handle);

    info.GetReturnValue().Set(New<Number>(curr));
}

NAN_METHOD(setSystemVolume) {
    snd_mixer_t *handle;
    snd_mixer_selem_id_t *sid;
    const char *card = "default";
    const char *selem_name = "Master";
    long volume = info[0]->ToNumber()->Value();

    snd_mixer_open(&handle, 0);
    snd_mixer_attach(handle, card);
    snd_mixer_selem_register(handle, NULL, NULL);
    snd_mixer_load(handle);

    snd_mixer_selem_id_alloca(&sid);
    snd_mixer_selem_id_set_index(sid, 0);
    snd_mixer_selem_id_set_name(sid, selem_name);
    snd_mixer_elem_t* elem = snd_mixer_find_selem(handle, sid);

    snd_mixer_selem_set_playback_volume_range(elem, 0, 100);

    snd_mixer_selem_set_playback_volume_all(elem, volume);

    snd_mixer_close(handle);

    info.GetReturnValue().Set(Nan::True());
}

NAN_MODULE_INIT(init) {
    Nan::Set(target, New<String>("setSystemVolume").ToLocalChecked(),
        GetFunction(New<FunctionTemplate>(setSystemVolume)).ToLocalChecked());
    Nan::Set(target, New<String>("getSystemVolume").ToLocalChecked(),
        GetFunction(New<FunctionTemplate>(getSystemVolume)).ToLocalChecked());
}

NODE_MODULE(nodealsa, init)
