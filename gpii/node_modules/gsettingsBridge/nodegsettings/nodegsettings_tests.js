/*
 * GPII Node.js GSettings Bridge
 *
 * Copyright 2012 Steven Githens
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/linux/blob/master/LICENSE.txt
 *
 * The research leading to these results has received funding from the European Union's
 * Seventh Framework Programme (FP7/2007-2013)
 * under grant agreement no. 289016.
 */

"use strict";

var jqUnit = require("node-jqunit");
var gsettings = require("./build/Release/nodegsettings.node");

/* Common variables for all tests */
var keyScreenmag = "org.gnome.desktop.a11y.magnifier";


jqUnit.module("Node gsettings tests...");

jqUnit.test("Test getting and setting boolean values...", function () {
    var original = gsettings.get_gsetting(keyScreenmag, "show-cross-hairs");
    jqUnit.assertDeepEq("We got a boolean as expected", "boolean", typeof(original));
    // assert.deepEqual(typeof(original), "boolean", "We got a boolean as expected");

    var ret = gsettings.set_gsetting(keyScreenmag, "show-cross-hairs", true);
    jqUnit.ok("Setting the value should succeed...", ret);

    var actual = gsettings.get_gsetting(keyScreenmag, "show-cross-hairs");
    jqUnit.assertEquals("We can set boolean values...", true, actual);

    ret = gsettings.set_gsetting(keyScreenmag, "show-cross-hairs", original);
    jqUnit.ok("We can set the value back to its previous value...", ret);

    // TODO: We need to set up an event for these assertions, they run too fast,
    // and get the old value from gsettings before it's propagated.
    // exec('gsettings get '+keyScreenmag+' show-cross-hairs', function(res, out, err) {
    //     testBooleanValuesCallback1 = true;
    //     assert.equal('true\n', out);
    // });

    // exec('gsettings get '+keyScreenmag+' show-cross-hairs', function(res, out, err) {
    //     testBooleanValuesCallback2 = true;
    //     assert.equal('false\n', out);
    // });
});

jqUnit.test("Test getting and setting decimal values...", function () {
    var original = gsettings.get_gsetting(keyScreenmag, "mag-factor");
    var ret = gsettings.set_gsetting(keyScreenmag, "mag-factor", 3.0);
    jqUnit.ok("Setting the value should succeed...", ret);

    var actual = gsettings.get_gsetting(keyScreenmag, "mag-factor");
    jqUnit.assertEquals("We can set decimal values", 3.0, actual);

    var ret2 = gsettings.set_gsetting(keyScreenmag, "mag-factor", 5.3);
    jqUnit.ok("Resetting the value should succeed...", ret2);
    actual = gsettings.get_gsetting(keyScreenmag, "mag-factor");
    jqUnit.assertEquals("We can reset decimal values", 5.3, actual);

    var ret3 = gsettings.set_gsetting(keyScreenmag, "mag-factor", original);
    jqUnit.ok("Setting the value should succeed...", ret3);
});

jqUnit.test("Test getting and setting string values...", function () {
    var original = gsettings.get_gsetting(keyScreenmag, "screen-position");
    var ret = gsettings.set_gsetting(keyScreenmag, "screen-position", "left-half");
    jqUnit.ok("Setting the value should succeed...", ret);
    var actual = gsettings.get_gsetting(keyScreenmag, "screen-position");
    jqUnit.assertEquals("We can set string values", "left-half", actual);
    var ret2 = gsettings.set_gsetting(keyScreenmag, "screen-position", original);
    jqUnit.ok("Setting the value should succeed...", ret2);
});

jqUnit.test("Test getting and setting integer values...", function () {
    var original = gsettings.get_gsetting(keyScreenmag, "cross-hairs-thickness");
    var ret = gsettings.set_gsetting(keyScreenmag, "cross-hairs-thickness", 7);
    jqUnit.ok("Setting the value should succeed...", ret);
    var actual = gsettings.get_gsetting(keyScreenmag, "cross-hairs-thickness");
    jqUnit.assertEquals("We can set integer values", 7, actual);
    var ret2 = gsettings.set_gsetting(keyScreenmag, "cross-hairs-thickness", original);
    jqUnit.ok("Setting the value should succeed...", ret2);
});

jqUnit.test("Test listing keys...", function () {
    var keys = gsettings.get_gsetting_keys(keyScreenmag);
    jqUnit.ok("Requesting a list of keys should return the correct type of variable...", Array.isArray(keys));

    for (var i = 0; i < keys.length; i++) {
        jqUnit.assertEquals("Each value in the list should be a string...", "string", typeof (keys[i]));
    }
});
