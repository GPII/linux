/*!
GPII Node.js PackageKit Bridge

Copyright 2012 Steven Githens
Copyright 2013, 2014 Inclusive Design Research Centre, OCAD University
Copyright 2013, 2014 Emergya

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

/*global require*/

var fluid = require ("universal"),
    jqUnit = fluid.require ("jqUnit"),
    packagekit = require ("./build/Release/nodepackagekit.node");

(function() {

  "use strict";

  var pkTests = fluid.registerNamespace ("gpii.tests.packageKit");

  pkTests.isInstalled = function (pkg) {
      return (!!pkg && (pkg.data.indexOf ("installed") !== -1));
  };

  pkTests.findGlib2 = function (aPkg) {
      return aPkg.name === "glib2";
  };

  pkTests.findPackageByName = function (name, pkgArray) {
      return fluid.find (pkgArray, function (aPkg) {
          if (aPkg.name === name) {
              return aPkg;
          }
      }, null);
  };

  // Return the package that matches name, version, and architecture.
  pkTests.getMatchingPackage = function (pkg, pkgList) {
      return fluid.find (pkgList, function (aPkg) {
          if (aPkg.name === pkg.name &&
              aPkg.version === pkg.version &&
              aPkg.arch === pkg.arch) {
              return aPkg;
          }
      }, null);
  };

  pkTests.initTuxguitar = function() {
      var tuxguitar = {
        pkgList: [],
        pkg: null,
        inInstalledList: false,
        inAvailableList: false
      };
      var pkgs = packagekit.searchPackage ("tuxguitar");
      tuxguitar.pkgList = pkgs;
      tuxguitar.pkg = pkTests.findPackageByName ("tuxguitar", pkgs);
      return tuxguitar;
  };

  pkTests.isTuxguitarInList = function (tuxguitar, pkgList) {
      var matchPkg = pkTests.getMatchingPackage (tuxguitar.pkg, pkgList);
      return (matchPkg !== null);
  };

  pkTests.initSearchTest = function() {
      var tuxguitar = pkTests.initTuxguitar();
      var installedPkgs = packagekit.searchPackage ("tuxguitar", "installed");
      tuxguitar.inInstalledList =
        pkTests.isTuxguitarInList (tuxguitar, installedPkgs);
      var availablePkgs = packagekit.searchPackage ("tuxguitar", "~installed");
      tuxguitar.inAvailableList =
        pkTests.isTuxguitarInList (tuxguitar, availablePkgs);
      return tuxguitar;
  };

  pkTests.initGetTest = function() {
      var tuxguitar = pkTests.initTuxguitar();
      var installedPkgs = packagekit.getPackages ("installed");
      tuxguitar.inInstalledList =
          pkTests.isTuxguitarInList (tuxguitar, installedPkgs);
      var availablePkgs = packagekit.getPackages ("~installed");
      tuxguitar.inAvailableList =
          pkTests.isTuxguitarInList (tuxguitar, availablePkgs);
      return tuxguitar;
  };

  pkTests.runInstalledVsAvailableTests = function (tuxguitar, msg) {
      // Depending on whether tuxguitar is installed on not, check that it
      // appears  correctly in the installed or available lists.
      if (pkTests.isInstalled (tuxguitar.pkg)) {
          jqUnit.assertTrue (msg + " 'tuxguitar' in installed packages list",
                              tuxguitar.inInstalledList);
          jqUnit.assertFalse (msg + " 'tuxguitar' not in available packages " +
                              "list", tuxguitar.inAvailableList);
      }
      else {
          jqUnit.assertFalse (msg + " 'tuxguitar' not in installed packages " +
                               "list", tuxguitar.inInstalledList);
          jqUnit.assertTrue (msg + " 'tuxguitar' is in available packages list",
                             tuxguitar.inAvailableList);
      }
  };

  pkTests.searchForMatch = function (tuxguitar, searchFilter) {
      var pkgs = packagekit.searchPackage ("tuxguitar", searchFilter);
      return pkTests.getMatchingPackage (tuxguitar.pkg, pkgs);
  };

  pkTests.testRemovePackage = function (tuxguitar, matchPkg) {
      var id = ( matchPkg !== null ? matchPkg.id : tuxguitar.pkg.id);

      // GPII-880:  The 'remove' action requires an administrator password.
      // Packagekit invokes PolKit authentication, putting up a dialog to
      // capture aforesaid password.  This needs to be automated.
      packagekit.performAction ("remove", id);
      matchPkg = pkTests.searchForMatch (tuxguitar, "~installed");
      jqUnit.assertNotNull ("Remove tuxguitar package", matchPkg);
      return matchPkg;
  };

  pkTests.testInstallPackage = function (tuxguitar, matchPkg) {
      var id = ( matchPkg !== null ? matchPkg.id : tuxguitar.pkg.id);
      packagekit.performAction ("install", id);
      matchPkg = pkTests.searchForMatch (tuxguitar, "installed");
      jqUnit.assertNotNull ("Install tuxguitar package", matchPkg);
      return matchPkg;
  };

  jqUnit.module ("PackageKit Bridge node add-on module");

  jqUnit.test (
      "Test searchPackage() of 'glib2' with implicit 'none' filter, meaning " +
      "installed or available.", function() {

      // Packagekit-glib -- the code this add-on invokes -- itself depends on
      // glib2.  It must be installed, if this is running.
      var pkgs = packagekit.searchPackage ("glib2");
      var found = pkgs.some (pkTests.findGlib2);
      jqUnit.assertTrue ("Search 'glib2', implicit 'none' filter", found);
  });

  jqUnit.test (
      "Test searchPackage() 'glib2' with explicit 'none' filter.", function() {

      var pkgs = packagekit.searchPackage ("glib2", "none");
      var found = pkgs.some (pkTests.findGlib2);
      jqUnit.assertTrue ("Search 'glib2', explicit 'none' filter", found);
  });

  jqUnit.test ("Test searchFiles() for '/usr/bin/ls'.", function() {

      // The searchFiles() function expects the full path name where the package
      // would be installed, even it if is not installed.  Check using the
      // common utility 'ls'.
      var pkgs = packagekit.searchFiles ("/usr/bin/ls");
      jqUnit.assertNotEquals (
          "Search file '/usr/bin/ls', implicit 'none' filter", 0, pkgs.length
      );
      jqUnit.assertTrue ("'ls' is installed", pkTests.isInstalled (pkgs[0]));
  });

  jqUnit.test ("Test searchPackage() with 'tuxguitar' comparing installed " +
               "vs. available filters.", function() {

      // Test the "installed" vs. "~installed" filters with regards to
      // 'tuxguitar', and the array of packages returned by searchPackage()
      // using the filters.  Use the tuxguitar package, whether installed or
      // not, to test against the two arrays.
      var tuxguitar = pkTests.initSearchTest();
      pkTests.runInstalledVsAvailableTests (tuxguitar, "Search");
  });

  jqUnit.test ("Test getPackages() with tuxguitar comparing installed vs. " +
               "available filters.", function() {
      var tuxguitar = pkTests.initGetTest();
      pkTests.runInstalledVsAvailableTests (tuxguitar, "Get");
  });

 jqUnit.test ("Test performAction(): 'install' and 'remove' tuxguitar." +
               "  The order depends on whether tuxguitar is currently " +
               "installed.", function() {

      // GPII-880:  The 'remove' test requires an administrator password.
      // Packagekit invokes PolKit authentication, putting up a dialog to
      // capture aforesaid password.  This needs to be automated.

      // Using the tuxguitar package:  If it's installed, test removing it and
      // then (re)install it ...
      var matchPkg;
      var tuxguitar = pkTests.initTuxguitar();
      if (pkTests.isInstalled (tuxguitar.pkg)) {
          matchPkg = pkTests.testRemovePackage (tuxguitar, null);
          pkTests.testInstallPackage (tuxguitar, matchPkg);
      }
      // ...if it isn't installed, test installing it and then removing it.
      else {
          matchPkg = pkTests.testInstallPackage (tuxguitar, null);
          pkTests.testRemovePackage (tuxguitar, matchPkg);
      }
  });

  jqUnit.test ("Test updatePackage(): with 'emacspeak'", function() {

      // The package ids of an old and newer version of 'emacspeak'.
      // TODO:  JS:  While the following check against two version of
      // 'emacspeak' works on Fedora-20, it may not work on all distros; hence,
      // the check that searchPackage() finds the two versions. If so, the test
      // is run; otherwise no test is run.  Need to find a better way to find
      // multiple versions of a package to test against.
      var oldEmacspeak = "38.0-5.fc20";
      var newEmacspeak = "39.0-1.fc20";
      var pkgs = packagekit.searchPackage ("emacspseak");
      if (pkgs.length === 2 &&
          (pkgs[0].version === oldEmacspeak &&
           pkgs[1].version === newEmacspeak &&
           pkgs[1].data.indexOf("updates") !== -1)) {

          packagekit.updatePackage (pkgs[1].id);
          var currentPkgs = packagekit.searchPackage ("emacspseak","installed");
          jqUnit.assertEquals ("Updating to " + newEmacspeak,
                               currentPkgs[0].version, newEmacspeak);

          // Restore to previous.
          packagekit.removePackage (currentPkgs[0].id);
      }
      else {
        jqUnit.assertTrue ("Cannot test update of emacspeak as there are no " +
                           "updates", true);
      }
  });
}());
