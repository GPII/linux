/**
 * GPII Process Reporter Bridge (Linux -- GLiBTop).
 *
 * Copyright 2015 OCAD University
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/gpii/universal/LICENSE.txt
 */

"use strict";

var fluid = require("universal");
var gpii = fluid.registerNamespace("gpii");
require("./processesBridge.js");

var processes = gpii.processes();

fluid.require("gsettingsBridge", require);
var gsettings = fluid.registerNamespace("gpii.gsettings");

fluid.registerNamespace("gpii.processReporter");
fluid.defaults("gpii.processReporter.find", {
    gradeNames: "fluid.function",
    argumentMap: {
        command: 0,
        schema: 1,  // optional
        setting: 2  // optional
    }
});

// Search for the process using its command name, and, optionally, if the
// given GSetting is set.  Returns a boolean indicating if the process is
// running (and if the setting is set).
gpii.processReporter.find = function (commandName, schema, setting) {
    var running = false;
    var procInfos = processes.findSolutionsByCommands([commandName]);
    var theProcess = fluid.find(procInfos, function (aProcInfo) {
        if (aProcInfo.uid === process.getuid()) {
            return aProcInfo;
        }
    }, null);
    if (theProcess !== null) {
        running = processes.isRunning(theProcess.state);
    }

    // Check GSetting as neccessary.
    if (!!schema && !!setting) {
        running = (running && gsettings.getSingleKey(schema, setting));
    }
    return running;
};
