/*!
GPII Node.js Processes Bridge Unit Tests

Copyright 2016 Inclusive Design Research Centre, OCAD University

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

/*global require*/

"use strict";

var spawn = require("child_process").spawn,
    fluid = require("universal");

require("../processesBridge.js");
var gpii = fluid.registerNamespace("gpii");
gpii.processes = fluid.registerNamespace("gpii.processes");
var processesBridge = gpii.processes();

var procTests = fluid.registerNamespace("gpii.tests.processes");

// Handler to detect any change in state.
procTests.stateChangedHandler = function (oldProcInfo, newProcInfo) {
    // Track until the state changes.
    if (oldProcInfo.state !== newProcInfo.state) {
        procTests.states.stateN = newProcInfo.state;
        processesBridge.stopTrackingState(
            procTests.stateChangedHandler, procTests.trackState
        );
    }
};

// Handler to detect change from "not running" to "running", or "running" to
// "not running".
procTests.runStateChangedHandler = function (procInfo) {
    // Track until the run state changes.
    procTests.states.runN = processesBridge.isRunning(procInfo.state);
    if (procTests.states.run0 !== procTests.states.runN) {
        processesBridge.stopTrackingRunState(
            procTests.runStateChangedHandler, procTests.trackRunState
        );
    }
};

// Set up to track the "grep" application state.  Start it here.
procTests.initStateTracking = function () {
    var grepProcInfo = processesBridge.findFirstProcessByCommand("grep");
    if (grepProcInfo === null) {
        grepProcInfo = processesBridge.initProcInfoNotRunning("grep");
    }
    procTests.states = {};
    procTests.states.state0 = grepProcInfo.state;
    procTests.states.stateN = procTests.states.state0;
    procTests.states.run0 = processesBridge.isRunning(grepProcInfo.state);
    procTests.states.runN = procTests.states.run0;

    procTests.trackState = processesBridge.trackState(
        grepProcInfo, procTests.stateChangedHandler
    );
    procTests.trackRunState = processesBridge.trackRunState(
        grepProcInfo, procTests.runStateChangedHandler
    );
};

// Setup:  start the tracking, then launch "grep".
procTests.initStateTracking();
var grep = spawn("grep", ["ssh"]);

// Wait a bit to allow the tracking functions to run, and then execute the
// tests.
setTimeout(function () {
    var jqUnit = fluid.require("node-jqunit");
    jqUnit.module("Processes Bridge module (tracking states)");
    jqUnit.test(
        "Test processes bridge tracking launching grep",
        function () {
            jqUnit.assertNotEquals("Process 'grep' state change",
                procTests.states.state0, procTests.states.stateN
            );
            jqUnit.assertFalse("Process 'grep' initial run state",
                procTests.states.run0
            );
            jqUnit.assertTrue("Process 'grep' final run state",
                procTests.states.runN
            );
            grep.kill("SIGHUP");
        }
    );
}, 100);

