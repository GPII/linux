/*!
GPII Node.js GSettings Bridge

Copyright 2012 Steven Githens

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

(function () {

    "use strict";

    var fluid = require("universal");
    var gpii = fluid.registerNamespace("gpii");
    var exec = require("child_process").exec;
    var util = require("util");
    var nodeGSettings = require("./nodegsettings/build/Release/nodegsettings.node");

    fluid.registerNamespace("gpii.launch");
    
    gpii.gsettings = gpii.gsettings || {};

    gpii.gsettings.get = function(settingsarray) {
        var togo = fluid.copy(settingsarray);
        for (var i = 0; i < togo.length; i++) {
            var settings = togo[i];
            for (var schemaId in settings) {
                if (settings[schemaId] === null) {
                    var keys = nodeGSettings.get_gsetting_keys(schemaId);
                    settings[schemaId] = {};
                    for (var k = 0; k < keys.length; k++) {
                        var key = keys[k];
                        settings[schemaId][key] = nodeGSettings.get_gsetting(schemaId,key);
                    }
                }
                else {
                    for (var settingKey in settings[schemaId]) {
                        settings[schemaId][settingKey] = nodeGSettings.get_gsetting(schemaId,settingKey);
                    }
                }
            }
        }
        return togo;
    };

    gpii.gsettings.set = function(settingsarray) {
        var togo = fluid.copy(settingsarray);
        for (var i = 0; i < togo.length; i++) {    
            var settings = togo[i];
            for (var schemaId in settings) {
                for (var settingKey in settings[schemaId].settings) {
                    var value = settings[schemaId].settings[settingKey];
                    var oldValue = nodeGSettings.get_gsetting(schemaId,settingKey);
                    nodeGSettings.set_gsetting(schemaId,settingKey,value);
                    settings[schemaId].settings[settingKey] = {
                        "oldValue": oldValue,
                        "newValue": value
                    };
                }
            }
        }
        return togo;
    }

})();